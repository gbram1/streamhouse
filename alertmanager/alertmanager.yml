# Alertmanager configuration for StreamHouse

global:
  resolve_timeout: 5m
  # SMTP configuration (uncomment and configure for email alerts)
  # smtp_smarthost: 'smtp.gmail.com:587'
  # smtp_from: 'alertmanager@streamhouse.io'
  # smtp_auth_username: 'your-email@gmail.com'
  # smtp_auth_password: 'your-app-password'

# Templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Routing tree
route:
  group_by: ['alertname', 'cluster', 'service', 'component']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'

  routes:
    # Critical alerts go to PagerDuty and Slack
    - match:
        severity: critical
      receiver: 'critical-alerts'
      continue: true

    # Warning alerts go to Slack only
    - match:
        severity: warning
      receiver: 'warning-alerts'

    # Consumer-specific alerts
    - match:
        component: consumer
      receiver: 'consumer-alerts'

    # Producer-specific alerts
    - match:
        component: producer
      receiver: 'producer-alerts'

    # Agent-specific alerts
    - match:
        component: agent
      receiver: 'agent-alerts'

# Alert inhibition rules
inhibit_rules:
  # Inhibit warning if critical is firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  # Inhibit consumer lag alerts if consumer is stalled
  - source_match:
      alertname: 'ConsumerStalled'
    target_match:
      alertname: 'HighConsumerLag'
    equal: ['instance', 'group_id']

# Receivers
receivers:
  # Default receiver (logs only)
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true

  # Critical alerts (PagerDuty + Slack)
  - name: 'critical-alerts'
    # PagerDuty configuration (uncomment and configure)
    # pagerduty_configs:
    #   - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
    #     description: '{{ template "pagerduty.default.description" . }}'
    #     severity: '{{ .CommonLabels.severity }}'
    #     details:
    #       firing: '{{ template "pagerduty.default.instances" .Alerts.Firing }}'
    #       resolved: '{{ template "pagerduty.default.instances" .Alerts.Resolved }}'

    # Slack configuration (uncomment and configure)
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#streamhouse-critical'
        color: 'danger'
        title: 'CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}
        send_resolved: true

  # Warning alerts (Slack only)
  - name: 'warning-alerts'
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#streamhouse-alerts'
        color: 'warning'
        title: 'Warning: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}
        send_resolved: true

  # Consumer-specific alerts
  - name: 'consumer-alerts'
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#streamhouse-consumers'
        title: 'Consumer Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Consumer Group:* {{ .Labels.group_id }}
          *Topic:* {{ .Labels.topic }}
          {{ end }}
        send_resolved: true

  # Producer-specific alerts
  - name: 'producer-alerts'
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#streamhouse-producers'
        title: 'Producer Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}
        send_resolved: true

  # Agent-specific alerts
  - name: 'agent-alerts'
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#streamhouse-agents'
        title: 'Agent Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}
        send_resolved: true
